// Vers√£o do app - deve corresponder √† vers√£o no service worker
const APP_VERSION = '1.1.0';

// Fun√ß√£o para verificar se o app est√° sendo executado como PWA instalado
const isPWA = () => {
  return window.matchMedia('(display-mode: standalone)').matches || 
         window.navigator.standalone || 
         document.referrer.includes('android-app://');
};

// Fun√ß√£o para mostrar uma mensagem toast
const showToast = (message, duration = 5000, type = 'info') => {
  // Remove qualquer toast existente
  const existingToast = document.getElementById('app-toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  // Cria um novo toast
  const toast = document.createElement('div');
  toast.id = 'app-toast';
  
  // Define o √≠cone com base no tipo
  let icon = 'üì±';
  if (type === 'offline') icon = 'üì¥';
  if (type === 'online') icon = 'üåê';
  if (type === 'error') icon = '‚ö†Ô∏è';
  
  toast.innerHTML = `
    <div style="display: flex; align-items: center;">
      <span style="margin-right: 10px;">${icon}</span>
      <span>${message}</span>
    </div>
  `;
  
  // Estilo baseado no tipo
  let backgroundColor = '#333';
  if (type === 'offline') backgroundColor = '#e74c3c';
  if (type === 'online') backgroundColor = '#2ecc71';
  if (type === 'error') backgroundColor = '#e67e22';
  
  toast.style.cssText = `
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    background-color: ${backgroundColor};
    color: white;
    padding: 12px 20px;
    border-radius: 4px;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    max-width: 90%;
    animation: fadeIn 0.3s ease-out;
  `;
  
  // Adiciona o toast ao corpo do documento
  document.body.appendChild(toast);
  
  // Remove ap√≥s o tempo especificado
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.5s';
    setTimeout(() => toast.remove(), 500);
  }, duration);
};

// Fun√ß√£o para verificar o status do service worker
const checkServiceWorkerStatus = async () => {
  if (!('serviceWorker' in navigator)) {
    console.warn('Service Workers n√£o s√£o suportados neste navegador');
    return false;
  }
  
  try {
    const registration = await navigator.serviceWorker.getRegistration();
    return registration && (registration.active || registration.installing || registration.waiting);
  } catch (error) {
    console.error('Erro ao verificar status do Service Worker:', error);
    return false;
  }
};

document.addEventListener('DOMContentLoaded', async () => {
  console.log('App vers√£o:', APP_VERSION);
  console.log('Executando como PWA:', isPWA());
  
  // Verifica se o service worker est√° ativo
  const swActive = await checkServiceWorkerStatus();
  console.log('Service Worker ativo:', swActive);
  
  // Verifica o status da conex√£o
  const isOffline = !navigator.onLine;
  console.log('Status de conex√£o:', isOffline ? 'Offline' : 'Online');
  
  // Se estiver offline, mostra uma mensagem amig√°vel
  if (isOffline) {
    console.log('Aplicativo iniciado em modo offline');
    
    // Atrasa um pouco para garantir que a p√°gina esteja carregada
    setTimeout(() => {
      showToast('Voc√™ est√° offline, mas o aplicativo est√° funcionando normalmente.', 5000, 'offline');
    }, 1000);
    
    // Atualiza o indicador de status
    const statusEl = document.getElementById('connection-status');
    if (statusEl) {
      statusEl.textContent = 'Offline';
      statusEl.classList.add('offline');
    }
  }
  
  // Ouve mensagens do service worker
  navigator.serviceWorker.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'SW_ACTIVATED') {
      console.log('Service Worker ativado, vers√£o:', event.data.version);
      
      // Se a vers√£o do SW for diferente da vers√£o do app, sugere recarregar
      if (event.data.version !== APP_VERSION) {
        showToast('Nova vers√£o dispon√≠vel. Recarregue a p√°gina para atualizar.', 10000);
      }
    }
  });
  
  // Adiciona listeners para eventos de conectividade
  window.addEventListener('online', () => {
    console.log('Conex√£o online detectada');
    
    // Atualiza o indicador de status
    const statusEl = document.getElementById('connection-status');
    if (statusEl) {
      statusEl.textContent = 'Online';
      statusEl.classList.remove('offline');
    }
    
    // Mostra uma mensagem toast
    showToast('Voc√™ est√° online novamente. Suas avalia√ß√µes ser√£o sincronizadas automaticamente.', 5000, 'online');
    
    // Tenta sincronizar dados pendentes
    if (typeof syncManager !== 'undefined') {
      setTimeout(() => {
        syncManager.syncData();
      }, 2000);
    }
  });
  
  window.addEventListener('offline', () => {
    console.log('Conex√£o offline detectada');
    
    // Atualiza o indicador de status
    const statusEl = document.getElementById('connection-status');
    if (statusEl) {
      statusEl.textContent = 'Offline';
      statusEl.classList.add('offline');
    }
    
    // Mostra uma mensagem toast
    showToast('Voc√™ est√° offline. Suas avalia√ß√µes ser√£o salvas localmente e sincronizadas quando voc√™ estiver online novamente.', 5000, 'offline');
  });
  
    // Lista de c√≥digos CNA para geleia
    const cnaCodes = [
      'CNA-5438',
      'CNA-8454',
      'CNA-3781',
      'CNA-4797',
      'CNA-3301',
      'CNA-2837',
      'CNA-8720',
      'CNA-2677',
      'CNA-8876',
      'CNA-6645'
    ];
    
    // Registra Service Worker com m√∫ltiplas tentativas de caminhos
    if ('serviceWorker' in navigator) {
      // Lista de poss√≠veis caminhos para o service worker
      const swPaths = [
        '/sw.js',                // Caminho absoluto da raiz
        './sw.js',               // Caminho relativo
        '../sw.js',              // Um n√≠vel acima
        '../../sw.js',           // Dois n√≠veis acima
        '../../../sw.js',        // Tr√™s n√≠veis acima
        window.location.pathname + 'sw.js' // Baseado no caminho atual
      ];
      
      // Fun√ß√£o para tentar registrar com diferentes caminhos
      const tryRegisterSW = async (paths, index = 0) => {
        if (index >= paths.length) {
          console.error('Falha em todas as tentativas de registro do Service Worker');
          return;
        }
        
        try {
          const registration = await navigator.serviceWorker.register(paths[index], {
            updateViaCache: 'none' // N√£o usar cache para atualiza√ß√µes do SW
          });
          console.log('Service Worker registrado com sucesso usando:', paths[index]);
          console.log('Scope:', registration.scope);
          
          // For√ßa a atualiza√ß√£o do service worker
          registration.update();
          
          // Verifica se o service worker est√° ativo
          if (registration.active) {
            console.log('Service Worker j√° est√° ativo');
          } else {
            console.log('Aguardando ativa√ß√£o do Service Worker...');
          }
          
          return registration;
        } catch (error) {
          console.warn(`Falha ao registrar SW com ${paths[index]}:`, error);
          return tryRegisterSW(paths, index + 1);
        }
      };
      
      // Inicia o processo de registro
      tryRegisterSW(swPaths)
        .then(registration => {
          if (registration) {
            // Verifica se h√° atualiza√ß√µes pendentes
            registration.addEventListener('updatefound', () => {
              console.log('Nova vers√£o do Service Worker encontrada!');
            });
          }
        });
    } else {
      console.warn('Service Workers n√£o s√£o suportados neste navegador. Funcionalidade offline limitada.');
    }
    
    // Inicializa o gerenciador de sincroniza√ß√£o
    const syncManager = new SyncManager(db);
    
    // Elementos do formul√°rio
    const form = document.getElementById('rating-form');
    const ratingButtons = document.querySelectorAll('.rating-btn');
    const ratingInput = document.getElementById('rating');
    const identifierSelect = document.getElementById('identifier');
    const commentsInput = document.getElementById('comments');
    const forceSyncButton = document.getElementById('force-sync');
    const lockToggleBtn = document.getElementById('lock-toggle');
    const unlockPanel = document.getElementById('unlock-panel');
    const unlockPasswordInput = document.getElementById('unlock-password');
    const unlockBtn = document.getElementById('unlock-btn');
    const cancelUnlockBtn = document.getElementById('cancel-unlock-btn');
    
    // Constantes
    const UNLOCK_PASSWORD = 'geleia123';
    const STORAGE_KEY_LOCKED = 'geleia_identifier_locked';
    const STORAGE_KEY_SELECTED = 'geleia_selected_code';
    const STORAGE_KEY_HEADER_IMAGE = 'geleia_header_image';
    
    // Preenche o dropdown com os c√≥digos CNA
    function populateIdentifierDropdown() {
      cnaCodes.forEach(code => {
        const option = document.createElement('option');
        option.value = code;
        option.textContent = code;
        identifierSelect.appendChild(option);
      });
      console.log('Dropdown populado com ' + cnaCodes.length + ' c√≥digos.');
    }
    
    // Inicializa o estado de bloqueio
    function initLockState() {
      const isLocked = localStorage.getItem(STORAGE_KEY_LOCKED) === 'true';
      const selectedCode = localStorage.getItem(STORAGE_KEY_SELECTED);
      
      if (isLocked) {
        lockIdentifier();
        
        // Se tiver um c√≥digo salvo, seleciona-o
        if (selectedCode) {
          identifierSelect.value = selectedCode;
        }
        console.log('Estado: Bloqueado com c√≥digo ' + identifierSelect.value);
      } else {
        unlockIdentifier(false); // false = n√£o mostrar o painel de senha
        console.log('Estado: Desbloqueado');
      }
    }
    
    // Bloqueia o identificador
    function lockIdentifier() {
      identifierSelect.disabled = true;
      lockToggleBtn.classList.add('locked');
      lockToggleBtn.classList.remove('unlocked');
      lockToggleBtn.querySelector('.lock-icon').textContent = 'üîí';
      unlockPanel.classList.add('hidden');
      
      // Salva o estado e o c√≥digo selecionado
      localStorage.setItem(STORAGE_KEY_LOCKED, 'true');
      localStorage.setItem(STORAGE_KEY_SELECTED, identifierSelect.value);
      
      console.log('Identificador bloqueado com o c√≥digo: ' + identifierSelect.value);
    }
    
    // Desbloqueia o identificador
    function unlockIdentifier(hidePanel = true) {
      identifierSelect.disabled = false;
      lockToggleBtn.classList.remove('locked');
      lockToggleBtn.classList.add('unlocked');
      lockToggleBtn.querySelector('.lock-icon').textContent = 'üîì';
      
      if (hidePanel) {
        unlockPanel.classList.add('hidden');
      }
      
      localStorage.setItem(STORAGE_KEY_LOCKED, 'false');
      
      console.log('Identificador desbloqueado');
    }
    
    // Inicializa o dropdown, o estado de bloqueio e a imagem de cabe√ßalho
    populateIdentifierDropdown();
    initLockState();
    initHeaderImage();
    
    // Inicializa a imagem de cabe√ßalho se existir
    function initHeaderImage() {
      const headerImageUrl = localStorage.getItem(STORAGE_KEY_HEADER_IMAGE);
      const headerImageContainer = document.getElementById('header-image-container');
      const headerImage = document.getElementById('header-image');
      
      if (headerImageUrl) {
        headerImage.src = headerImageUrl;
        headerImageContainer.classList.remove('hidden');
        console.log('Imagem de cabe√ßalho carregada: ' + headerImageUrl);
      }
    }
    
    // Fun√ß√£o para definir uma imagem de cabe√ßalho (pode ser chamada via console)
    window.setHeaderImage = function(imageUrl) {
      const headerImageContainer = document.getElementById('header-image-container');
      const headerImage = document.getElementById('header-image');
      
      if (imageUrl) {
        headerImage.src = imageUrl;
        headerImageContainer.classList.remove('hidden');
        localStorage.setItem(STORAGE_KEY_HEADER_IMAGE, imageUrl);
        console.log('Imagem de cabe√ßalho definida: ' + imageUrl);
      } else {
        headerImageContainer.classList.add('hidden');
        localStorage.removeItem(STORAGE_KEY_HEADER_IMAGE);
        console.log('Imagem de cabe√ßalho removida');
      }
    };
    
    // Event listeners para o bot√£o de bloqueio/desbloqueio
    lockToggleBtn.addEventListener('click', () => {
      const isLocked = localStorage.getItem(STORAGE_KEY_LOCKED) === 'true';
      
      if (isLocked) {
        // Mostra o painel de senha para desbloquear
        unlockPanel.classList.remove('hidden');
        unlockPasswordInput.focus();
        console.log('Painel de senha exibido');
      } else {
        // Bloqueia diretamente
        lockIdentifier();
      }
    });
    
    // Event listener para o bot√£o de desbloquear
    unlockBtn.addEventListener('click', () => {
      const password = unlockPasswordInput.value;
      
      if (password === UNLOCK_PASSWORD) {
        unlockIdentifier();
        unlockPasswordInput.value = '';
        console.log('Senha correta, identificador desbloqueado');
      } else {
        alert('Senha incorreta!');
        console.log('Senha incorreta');
      }
    });
    
    // Event listener para o bot√£o de cancelar desbloqueio
    cancelUnlockBtn.addEventListener('click', () => {
      unlockPanel.classList.add('hidden');
      unlockPasswordInput.value = '';
      console.log('Desbloqueio cancelado');
    });
    
    // Permite pressionar Enter no campo de senha
    unlockPasswordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        unlockBtn.click();
      }
    });
    
    // Manipula cliques nos bot√µes de avalia√ß√£o
    ratingButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Remove sele√ß√£o anterior
        ratingButtons.forEach(btn => btn.classList.remove('selected'));
        
        // Seleciona o bot√£o atual
        button.classList.add('selected');
        
        // Atualiza o valor oculto
        ratingInput.value = button.dataset.value;
      });
    });
    
    // Manipula envio do formul√°rio
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      
      // Valida√ß√£o b√°sica
      if (!identifierSelect.value || !ratingInput.value) {
        alert('Por favor, preencha o identificador e selecione uma avalia√ß√£o para a geleia.');
        return;
      }
      
      // Cria objeto para salvar
      const rating = {
        identifier: identifierSelect.value,
        rating: parseInt(ratingInput.value, 10),
        comments: '' // Campo de coment√°rios removido, mas mantido no objeto para compatibilidade
      };
      
      try {
        // Salva no banco de dados local
        await db.saveRating(rating);
        
        // Limpa formul√°rio mantendo o c√≥digo da geleia se estiver bloqueado
        const isLocked = localStorage.getItem(STORAGE_KEY_LOCKED) === 'true';
        const selectedCode = isLocked ? identifierSelect.value : '';
        
        // Limpa a sele√ß√£o de avalia√ß√£o
        ratingButtons.forEach(btn => btn.classList.remove('selected'));
        ratingInput.value = '';
        
        // Se n√£o estiver bloqueado, reseta o select tamb√©m
        if (!isLocked) {
          identifierSelect.value = '';
        }
        
        alert('Avalia√ß√£o da geleia registrada com sucesso!');
        
      } catch (error) {
        console.error('Error saving rating:', error);
        alert('Erro ao salvar avalia√ß√£o. Por favor, tente novamente.');
      }
    });
    
    // Bot√£o para for√ßar sincroniza√ß√£o
    forceSyncButton.addEventListener('click', () => {
      if (navigator.onLine) {
        syncManager.syncData();
      } else {
        alert('Voc√™ est√° offline. Conecte-se √† Internet para sincronizar.');
      }
    });
  });
